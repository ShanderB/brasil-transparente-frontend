name: Deploy to Test Environment

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Commit SHA or branch (default: HEAD)"
        required: false
        default: ""

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: test
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || github.sha }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22.14.0"

      - name: Debug: dump secret sizes
        run: |
          echo "GCP_PROJECT length: ${#GCP_PROJECT}" || true
          echo "GCP_SA_KEY length: $(echo -n \"${GCP_SA_KEY}\" | wc -c)" || true
        env:
          GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}

      - name: Write SA key to file
        run: |
          mkdir -p /tmp/gcloud
          printf "%s" "${GCP_SA_KEY}" > /tmp/gcloud/key.json
          echo "Wrote key, showing head/tail (not full key):"
          head -n2 /tmp/gcloud/key.json || true
          tail -n2 /tmp/gcloud/key.json || true
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}

      - name: Install gcloud (if needed) and show version
        run: |
          gcloud --version || true

      - name: Activate service account explicitly (debug)
        run: |
          gcloud auth activate-service-account --key-file=/tmp/gcloud/key.json --project="${{ secrets.GCP_PROJECT }}"
          gcloud auth list
          gcloud config list
